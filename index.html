<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>LouLou's | Door List</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Jost:wght@300;400;500;600&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --cream:#EDE8E0;
      --cream-dark:#E0D9CE;
      --terracotta:#E8532A;
      --near-black:#1C1814;
      --brown:#5C4A3A;
      --gold:#C9A96E;
      --surface:#F5F1EA;
      --white:#ffffff;
    }

    *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
    body{
      background:var(--cream);
      color:var(--near-black);
      font-family:'Jost',sans-serif;
      min-height:100vh;
      overflow-x:hidden;
    }
    a{ color:inherit; }

    .header{
      position:sticky;
      top:0;
      z-index:100;
      background:var(--near-black);
      padding:14px 18px 0;
      box-shadow:0 2px 18px rgba(0,0,0,0.35);
    }
    .header-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding-bottom:10px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .logo{
      font-family:'Playfair Display',serif;
      font-size:22px;
      color:var(--terracotta);
      letter-spacing:0.02em;
      line-height:1.1;
      white-space:nowrap;
    }
    .event-name{
      font-family:'Cormorant Garamond',serif;
      color:rgba(237,232,224,0.78);
      letter-spacing:0.14em;
      text-transform:uppercase;
      font-size:12px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60vw;
    }
    .stats{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    .guest-count{
      color:var(--gold);
      font-size:12px;
      font-weight:300;
      letter-spacing:0.12em;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .logout-btn{
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.06);
      color:rgba(237,232,224,0.82);
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
    }

    .tabs{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom:10px;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{ display:none; }
    .tab{
      border:none;
      background:rgba(255,255,255,0.07);
      color:rgba(237,232,224,0.72);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:11px;
      font-weight:500;
      letter-spacing:0.12em;
      text-transform:uppercase;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tab.active{
      background:rgba(232,83,42,0.18);
      color:var(--terracotta);
      border:1px solid rgba(232,83,42,0.35);
    }

    .subbar{
      position:sticky;
      top:86px;
      z-index:90;
      background:var(--surface);
      border-bottom:1px solid var(--cream-dark);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .event-select{
      flex:0 0 260px;
      max-width:52vw;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--cream-dark);
      background:var(--white);
      font-size:13px;
      outline:none;
      cursor:pointer;
    }
    .search{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--cream-dark);
      background:var(--white);
      font-size:14px;
      outline:none;
    }
    .search:focus{ border-color:rgba(232,83,42,0.55); }

    .main{
      padding:12px;
    }

    .guest-grid{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:10px;
    }
    @media (min-width: 768px){
      .guest-grid{ grid-template-columns:repeat(6, 1fr); }
      .subbar{ padding:12px 18px; }
      .main{ padding:18px; }
      .header{ padding:16px 18px 0; }
    }
    @media (min-width: 1100px){
      .guest-grid{ grid-template-columns:repeat(7, 1fr); }
    }

    .guest-card{
      background:var(--white);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
      transition:transform 120ms ease, box-shadow 120ms ease;
      position:relative;
    }
    .guest-card:active{ transform:scale(0.98); }
    .guest-card:focus{ outline:none; box-shadow:0 0 0 2px rgba(232,83,42,0.35), 0 2px 10px rgba(0,0,0,0.12); }

    .guest-card.checked-in::after{
      content:"‚úì";
      position:absolute;
      top:8px;
      right:8px;
      width:22px;
      height:22px;
      border-radius:50%;
      background:var(--terracotta);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:12px;
      z-index:2;
    }

    .tile{
      width:100%;
      aspect-ratio:1 / 1;
      background:var(--cream-dark);
      position:relative;
      overflow:hidden;
    }
    .tile img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      display:block;
      pointer-events:none;
    }
    .tile .initial{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:'Playfair Display',serif;
      font-size:30px;
      color:rgba(92,74,58,0.6);
      pointer-events:none;
    }

    .card-meta{
      padding:10px 10px 12px;
    }
    .card-name{
      font-size:12px;
      font-weight:500;
      color:var(--near-black);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .card-type{
      margin-top:3px;
      font-size:10px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(232,83,42,0.85);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .state{
      padding:60px 14px;
      text-align:center;
      color:var(--brown);
      font-family:'Cormorant Garamond',serif;
      font-size:18px;
    }
    .spinner{
      width:36px;
      height:36px;
      border:2px solid var(--cream-dark);
      border-top-color:var(--terracotta);
      border-radius:50%;
      margin:0 auto 14px;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to{ transform:rotate(360deg); } }

    /* Detail sheet */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(28,24,20,0.6);
      display:none;
      z-index:200;
      backdrop-filter:blur(4px);
    }
    .overlay.open{ display:block; }

    .sheet{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      background:var(--surface);
      border-radius:22px 22px 0 0;
      max-height:92vh;
      overflow:auto;
      transform:translateY(100%);
      transition:transform 280ms cubic-bezier(0.32,0.72,0,1);
      z-index:201;
      -webkit-overflow-scrolling:touch;
    }
    .sheet.open{ transform:translateY(0); }

    .handle{
      width:40px;
      height:4px;
      background:var(--cream-dark);
      border-radius:4px;
      margin:12px auto 0;
    }

    .detail-header{
      padding:18px 18px 0;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .avatar{
      width:120px;
      height:120px;
      border-radius:50%;
      overflow:hidden;
      border:3px solid var(--cream-dark);
      background:linear-gradient(135deg, var(--cream-dark), var(--cream));
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:'Playfair Display',serif;
      font-size:42px;
      color:rgba(92,74,58,0.6);
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      display:block;
    }
    .detail-name{
      font-family:'Playfair Display',serif;
      font-size:26px;
      font-weight:500;
      text-align:center;
      padding:0 10px;
    }
    .detail-badge{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(232,83,42,0.85);
    }

    .detail-body{
      padding:10px 18px 24px;
    }
    .section-title{
      margin-top:18px;
      margin-bottom:10px;
      font-size:10px;
      letter-spacing:0.2em;
      text-transform:uppercase;
      color:rgba(92,74,58,0.75);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 0;
      border-bottom:1px solid var(--cream-dark);
    }
    .row-label{
      font-size:15px;
      color:var(--near-black);
      display:flex;
      align-items:center;
      gap:10px;
    }

    .toggle{
      position:relative;
      width:52px;
      height:30px;
      flex:0 0 auto;
    }
    .toggle input{ opacity:0; width:0; height:0; }
    .slider{
      position:absolute;
      inset:0;
      border-radius:999px;
      background:var(--cream-dark);
      cursor:pointer;
      transition:background 160ms ease;
    }
    .slider::before{
      content:"";
      position:absolute;
      width:24px;
      height:24px;
      left:3px;
      top:3px;
      background:#fff;
      border-radius:50%;
      box-shadow:0 1px 4px rgba(0,0,0,0.15);
      transition:transform 160ms ease;
    }
    .toggle input:checked + .slider{ background:var(--terracotta); }
    .toggle input:checked + .slider::before{ transform:translateX(22px); }

    .linkrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 0 0;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--cream-dark);
      background:rgba(255,255,255,0.7);
      font-size:13px;
      color:var(--brown);
      text-decoration:none;
    }
    .pill strong{ color:var(--near-black); font-weight:600; }

    .field{
      padding:14px 0;
      border-bottom:1px solid var(--cream-dark);
    }
    .field label{
      display:block;
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(92,74,58,0.75);
      margin-bottom:8px;
    }
    .field input, .field textarea{
      width:100%;
      border:1px solid var(--cream-dark);
      border-radius:12px;
      padding:12px 12px;
      background:#fff;
      outline:none;
      font-family:'Jost',sans-serif;
      font-size:15px;
      color:var(--near-black);
    }
    .field textarea{ min-height:90px; resize:none; line-height:1.45; }
    .field input:focus, .field textarea:focus{ border-color:rgba(232,83,42,0.55); }

    .save{
      margin-top:18px;
      width:100%;
      border:none;
      border-radius:14px;
      padding:16px 14px;
      background:var(--terracotta);
      color:#fff;
      font-size:13px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      font-weight:600;
      cursor:pointer;
    }
    .save:active{ transform:scale(0.99); }

    /* Login modal */
    .login{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(28,24,20,0.72);
      z-index:300;
      padding:18px;
    }
    .login.open{ display:flex; }
    .login-card{
      width:min(420px, 100%);
      background:var(--surface);
      border-radius:18px;
      padding:18px 16px;
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
    }
    .login-title{
      font-family:'Playfair Display',serif;
      font-size:22px;
      color:var(--near-black);
      margin-bottom:6px;
      text-align:center;
    }
    .login-sub{
      text-align:center;
      color:rgba(92,74,58,0.8);
      font-size:13px;
      margin-bottom:14px;
    }
    .login-card .field{ border-bottom:none; padding:10px 0; }
    .login-btn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:14px 14px;
      background:var(--near-black);
      color:rgba(237,232,224,0.92);
      font-size:12px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      cursor:pointer;
      margin-top:8px;
    }
    .login-error{
      margin-top:10px;
      font-size:13px;
      color:var(--terracotta);
      text-align:center;
      min-height:18px;
    }

    .hidden{ display:none; }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-top">
      <div class="brand">
        <div class="logo">LouLou's</div>
        <div class="event-name" id="eventName">Loading...</div>
      </div>
      <div class="stats">
        <div class="guest-count" id="guestCount"></div>
        <button class="logout-btn" id="logoutBtn" type="button">Log out</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Sections">
      <button class="tab active" data-tab="door" type="button">üë• Door List</button>
      <button class="tab" data-tab="guests" type="button">üî• Guests</button>
      <button class="tab" data-tab="working" type="button">üç∏ Working</button>
      <button class="tab" data-tab="ndas" type="button">‚úçÔ∏è NDAs</button>
    </div>
  </div>

  <div class="subbar">
    <select class="event-select" id="eventSelect"></select>
    <input class="search" id="searchInput" placeholder="Search guests..." />
  </div>

  <div class="main" id="mainContent">
    <div class="state">
      <div class="spinner"></div>
      Opening the doors...
    </div>
  </div>

  <!-- Detail -->
  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet" aria-modal="true" role="dialog">
    <div class="handle"></div>
    <div id="detailRoot"></div>
  </div>

  <!-- Login -->
  <div class="login" id="login">
    <div class="login-card">
      <div class="login-title">Staff Access</div>
      <div class="login-sub">Enter your username and passcode.</div>

      <div class="field">
        <label>Username</label>
        <input id="loginUser" autocomplete="username" />
      </div>
      <div class="field">
        <label>Passcode</label>
        <input id="loginPass" type="password" autocomplete="current-password" />
      </div>

      <button class="login-btn" id="loginBtn" type="button">Sign In</button>
      <div class="login-error" id="loginError"></div>
    </div>
  </div>

  <script>
    // 1) Set this to your Cloudflare Worker URL, no trailing slash.
    // Example: https://loulous-door-api.YOURNAME.workers.dev
    const API_BASE = "https://YOUR-WORKER-URL.workers.dev";

    // Airtable fields expected in your Door List table:
    // Full Name, Photo (attachment), List, Email, Phone, Instagram,
    // Checked In (checkbox), VIP Wristband (checkbox), NDA Signed (checkbox), STI Verified (checkbox),
    // Coat Check #, Door Notes, Ticket Type, Tags
    //
    // Your Worker should expose:
    // GET  /api/ping
    // GET  /api/events
    // GET  /api/records?table=TABLE_NAME
    // PATCH /api/record?table=TABLE_NAME&id=RECORD_ID

    const state = {
      tab: "door",
      events: [],
      table: "",
      guests: [],
      query: "",
      currentGuest: null,
      auth: ""
    };

    const $ = (id) => document.getElementById(id);

    function setAuth(user, pass) {
      state.auth = "Basic " + btoa(user + ":" + pass);
      localStorage.setItem("loulous_auth", state.auth);
    }

    function clearAuth() {
      state.auth = "";
      localStorage.removeItem("loulous_auth");
    }

    function authHeaders() {
      return { "Authorization": state.auth };
    }

    async function api(path, opts = {}) {
      const res = await fetch(API_BASE + path, {
        ...opts,
        headers: {
          ...(opts.headers || {}),
          ...authHeaders(),
          "Content-Type": "application/json"
        }
      });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(text || ("HTTP " + res.status));
      }
      return res.json();
    }

    function showLoading(msg) {
      $("mainContent").innerHTML = `
        <div class="state">
          <div class="spinner"></div>
          ${msg || "Opening the doors..."}
        </div>`;
    }

    function showState(msg) {
      $("mainContent").innerHTML = `<div class="state">${msg}</div>`;
    }

    function openLogin(errorMsg) {
      $("login").classList.add("open");
      $("loginError").textContent = errorMsg || "";
      $("loginUser").focus();
    }

    function closeLogin() {
      $("login").classList.remove("open");
      $("loginError").textContent = "";
    }

    async function tryExistingAuth() {
      const saved = localStorage.getItem("loulous_auth");
      if (!saved) return false;
      state.auth = saved;
      try {
        await api("/api/ping");
        return true;
      } catch {
        clearAuth();
        return false;
      }
    }

    async function login() {
      const user = $("loginUser").value.trim();
      const pass = $("loginPass").value;
      if (!user || !pass) {
        $("loginError").textContent = "Please enter both fields.";
        return;
      }
      setAuth(user, pass);
      try {
        await api("/api/ping");
        closeLogin();
        await bootstrap();
      } catch (e) {
        clearAuth();
        $("loginError").textContent = "Incorrect username or passcode.";
      }
    }

    function setTabs() {
      document.querySelectorAll(".tab").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === state.tab);
      });
    }

    function applyTabFilter(list) {
      const tab = state.tab;

      if (tab === "door") return list;

      if (tab === "guests") {
        return list.filter(g => !isWorking(g.list));
      }

      if (tab === "working") {
        return list.filter(g => isWorking(g.list));
      }

      if (tab === "ndas") {
        // Show anyone who has NOT signed NDA
        return list.filter(g => !g.ndaSigned);
      }

      return list;
    }

    function isWorking(listVal) {
      const l = (listVal || "").toLowerCase();
      return l.includes("work") || l.includes("staff");
    }

    function normalizeInstagram(val) {
      if (!val) return "";
      let v = String(val).trim();
      if (!v) return "";
      v = v.replace(/^@/, "");
      v = v.replace(/^https?:\/\/(www\.)?instagram\.com\//, "");
      v = v.replace(/\/$/, "");
      return v;
    }

    function guestFromRecord(r) {
      const f = r.fields || {};
      const photoUrl = Array.isArray(f["Photo"]) && f["Photo"][0] && f["Photo"][0].url ? f["Photo"][0].url : "";
      return {
        id: r.id,
        name: f["Full Name"] || "Unknown",
        photo: photoUrl,
        list: f["List"] || "",
        email: f["Email"] || "",
        phone: f["Phone"] || "",
        instagram: normalizeInstagram(f["Instagram"] || ""),
        checkedIn: !!f["Checked In"],
        vip: !!f["VIP Wristband"],
        ndaSigned: !!f["NDA Signed"],
        sti: !!f["STI Verified"],
        coat: f["Coat Check #"] || "",
        notes: f["Door Notes"] || "",
        ticketType: f["Ticket Type"] || "",
        tags: Array.isArray(f["Tags"]) ? f["Tags"] : []
      };
    }

    function render() {
      const q = state.query.trim().toLowerCase();

      let list = state.guests.slice();
      if (q) {
        list = list.filter(g => (g.name || "").toLowerCase().includes(q));
      }

      list = applyTabFilter(list);

      $("guestCount").textContent = list.length ? (list.length + " people") : "";

      if (!list.length) {
        showState("No guests found.");
        return;
      }

      const grid = document.createElement("div");
      grid.className = "guest-grid";

      for (const g of list) {
        const card = document.createElement("div");
        card.className = "guest-card" + (g.checkedIn ? " checked-in" : "");
        card.setAttribute("role", "button");
        card.setAttribute("tabindex", "0");
        card.setAttribute("aria-label", "Open " + g.name);

        const tile = document.createElement("div");
        tile.className = "tile";
        if (g.photo) {
          const img = document.createElement("img");
          img.src = g.photo;
          img.alt = g.name;
          img.loading = "lazy";
          tile.appendChild(img);
        } else {
          const init = document.createElement("div");
          init.className = "initial";
          init.textContent = (g.name || "U").charAt(0);
          tile.appendChild(init);
        }

        const meta = document.createElement("div");
        meta.className = "card-meta";
        const nm = document.createElement("div");
        nm.className = "card-name";
        nm.textContent = g.name;
        meta.appendChild(nm);

        const ty = document.createElement("div");
        ty.className = "card-type";
        ty.textContent = g.list || " ";
        meta.appendChild(ty);

        card.appendChild(tile);
        card.appendChild(meta);

        // Reliable tap on iPhone and iPad
        const open = () => openDetail(g);
        card.addEventListener("pointerup", (e) => {
          if (e && typeof e.button === "number" && e.button !== 0) return;
          open();
        });
        card.addEventListener("click", open);
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            open();
          }
        });

        grid.appendChild(card);
      }

      $("mainContent").innerHTML = "";
      $("mainContent").appendChild(grid);
    }

    function openSheet() {
      $("overlay").classList.add("open");
      $("sheet").classList.add("open");
    }

    function closeSheet() {
      $("sheet").classList.remove("open");
      $("overlay").classList.remove("open");
      $("detailRoot").innerHTML = "";
      state.currentGuest = null;
    }

    function detailHTML(g) {
      const ig = g.instagram ? `https://instagram.com/${g.instagram}` : "";
      const igLabel = g.instagram ? `@${g.instagram}` : "";

      const tags = (g.tags && g.tags.length)
        ? `<div class="section-title">Tags</div><div class="linkrow">${
            g.tags.map(t => `<span class="pill"><strong>${escapeHtml(t)}</strong></span>`).join("")
          }</div>`
        : "";

      const ticket = g.ticketType
        ? `<div class="section-title">Ticket Type</div><div class="linkrow"><span class="pill"><strong>${escapeHtml(g.ticketType)}</strong></span></div>`
        : "";

      return `
        <div class="detail-header">
          <div class="avatar">
            ${g.photo ? `<img src="${escapeAttr(g.photo)}" alt="${escapeAttr(g.name)}" />` : `${escapeHtml((g.name||"U").charAt(0))}`}
          </div>
          <div class="detail-name">${escapeHtml(g.name)}</div>
          <div class="detail-badge">${escapeHtml(g.list || "")}</div>
        </div>

        <div class="detail-body">
          <div class="section-title">Contact</div>
          <div class="linkrow">
            ${g.email ? `<a class="pill" href="mailto:${escapeAttr(g.email)}">‚úâÔ∏è <strong>${escapeHtml(g.email)}</strong></a>` : ""}
            ${g.phone ? `<a class="pill" href="tel:${escapeAttr(g.phone)}">üìû <strong>${escapeHtml(g.phone)}</strong></a>` : ""}
            ${ig ? `<a class="pill" target="_blank" rel="noopener" href="${escapeAttr(ig)}">üì∏ <strong>${escapeHtml(igLabel)}</strong></a>` : ""}
          </div>

          ${ticket}
          ${tags}

          <div class="section-title">Check-In</div>

          ${toggleRow("Checked In", "checkedIn", g.checkedIn, "‚úì")}
          ${toggleRow("VIP Wristband", "vip", g.vip, "üéóÔ∏è")}
          ${toggleRow("NDA Signed", "ndaSigned", g.ndaSigned, "‚úçÔ∏è")}
          ${toggleRow("STI Verified", "sti", g.sti, "üß™")}

          <div class="field">
            <label>Coat Check #</label>
            <input id="coat" placeholder="e.g. 69" value="${escapeAttr(g.coat)}" />
          </div>

          <div class="field">
            <label>Door Notes</label>
            <textarea id="notes" placeholder="Enter any notes">${escapeHtml(g.notes)}</textarea>
          </div>

          <button class="save" id="saveBtn" type="button">Save</button>
        </div>
      `;
    }

    function toggleRow(label, key, checked, icon) {
      const id = "t_" + key;
      return `
        <div class="row">
          <div class="row-label">${icon} ${escapeHtml(label)}</div>
          <label class="toggle">
            <input type="checkbox" id="${id}" ${checked ? "checked" : ""} />
            <span class="slider"></span>
          </label>
        </div>
      `;
    }

    function openDetail(g) {
      state.currentGuest = { ...g };
      $("detailRoot").innerHTML = detailHTML(state.currentGuest);

      $("saveBtn").addEventListener("click", saveDetail);
      openSheet();
    }

    async function saveDetail() {
      const g = state.currentGuest;
      if (!g) return;

      const updated = {
        "Checked In": !!$("t_checkedIn").checked,
        "VIP Wristband": !!$("t_vip").checked,
        "NDA Signed": !!$("t_ndaSigned").checked,
        "STI Verified": !!$("t_sti").checked,
        "Coat Check #": $("coat").value.trim(),
        "Door Notes": $("notes").value.trim()
      };

      const btn = $("saveBtn");
      btn.textContent = "Saving...";
      btn.disabled = true;

      try {
        await api(`/api/record?table=${encodeURIComponent(state.table)}&id=${encodeURIComponent(g.id)}`, {
          method: "PATCH",
          body: JSON.stringify({ fields: updated })
        });

        // Update local state immediately
        const idx = state.guests.findIndex(x => x.id === g.id);
        if (idx >= 0) {
          const merged = { ...state.guests[idx] };
          merged.checkedIn = updated["Checked In"];
          merged.vip = updated["VIP Wristband"];
          merged.ndaSigned = updated["NDA Signed"];
          merged.sti = updated["STI Verified"];
          merged.coat = updated["Coat Check #"];
          merged.notes = updated["Door Notes"];
          state.guests[idx] = merged;
        }

        btn.textContent = "Saved ‚úì";
        setTimeout(() => {
          closeSheet();
          render();
        }, 450);

      } catch (e) {
        btn.textContent = "Error, try again";
        btn.disabled = false;
      }
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s) {
      return escapeHtml(s).replaceAll("\n"," ").replaceAll("\r"," ");
    }

    async function loadEvents() {
      // Expected response: { events: [{ name: "...", table: "..." }, ...] }
      const data = await api("/api/events");
      state.events = Array.isArray(data.events) ? data.events : [];
      if (!state.events.length) throw new Error("No events returned.");
    }

    function populateEventSelect() {
      const sel = $("eventSelect");
      sel.innerHTML = "";
      for (const ev of state.events) {
        const opt = document.createElement("option");
        opt.value = ev.table;
        opt.textContent = ev.name;
        sel.appendChild(opt);
      }
      state.table = sel.value || (state.events[0] ? state.events[0].table : "");
      const current = state.events.find(e => e.table === state.table) || state.events[0];
      $("eventName").textContent = current ? current.name : "";
    }

    async function loadGuests() {
      showLoading("Loading guest list...");
      const data = await api(`/api/records?table=${encodeURIComponent(state.table)}`);
      const records = Array.isArray(data.records) ? data.records : [];
      state.guests = records.map(guestFromRecord);
      render();
    }

    async function bootstrap() {
      try {
        showLoading("Loading events...");
        await loadEvents();
        populateEventSelect();
        await loadGuests();
      } catch (e) {
        showState("Could not load. Check API_BASE and your Worker.");
      }
    }

    // Wire UI
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        state.tab = btn.dataset.tab;
        setTabs();
        render();
      });
    });

    $("eventSelect").addEventListener("change", async (e) => {
      state.table = e.target.value;
      const current = state.events.find(x => x.table === state.table);
      $("eventName").textContent = current ? current.name : "";
      await loadGuests();
    });

    $("searchInput").addEventListener("input", (e) => {
      state.query = e.target.value || "";
      render();
    });

    $("overlay").addEventListener("click", closeSheet);

    $("logoutBtn").addEventListener("click", () => {
      clearAuth();
      openLogin("Signed out.");
    });

    $("loginBtn").addEventListener("click", login);
    $("loginPass").addEventListener("keydown", (e) => {
      if (e.key === "Enter") login();
    });

    // Start
    (async function start() {
      const ok = await tryExistingAuth();
      if (!ok) openLogin("");
      else await bootstrap();
    })();
  </script>
</body>
</html>
