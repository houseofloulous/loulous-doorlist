<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>LouLou's ‚Äî Door List</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  <script>
var TOKEN = 'patQHgI1DOfeXw98H.da543b89b12e2aaa5a30980aafb3e5df35c6f87e5c23f7fa9c22e443ff5816f6';
var BASE_ID = 'appY6p2HwRtDmOvAf';

var EVENTS = [
  { name: "L'Atelier | March 28th", table: "3/28 Door List" },
  { name: "Do Not Disturb II | Feb 28th", table: "2/28 Door List" },
  { name: "Do Not Disturb I | Dec 13th", table: "12/13 Door List" }
];

var allGuests = [];
var currentTab = 'all';
var currentTable = EVENTS[0].table;
var currentGuest = null;

function apiHeaders() {
  return { 'Authorization': 'Bearer ' + TOKEN, 'Content-Type': 'application/json' };
}

function fetchAll(table, callback) {
  var records = [];
  function fetchPage(offset) {
    var url = 'https://api.airtable.com/v0/' + BASE_ID + '/' + encodeURIComponent(table) + '?pageSize=100';
    if (offset) url += '&offset=' + offset;
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN);
    xhr.onload = function() {
      var data = JSON.parse(xhr.responseText);
      if (data.error) { callback(null, data.error.message); return; }
      records = records.concat(data.records);
      if (data.offset) { fetchPage(data.offset); } else { callback(records, null); }
    };
    xhr.onerror = function() { callback(null, 'Network error'); };
    xhr.send();
  }
  fetchPage(null);
}

function init() {
  var sel = document.getElementById('eventSelect');
  for (var i = 0; i < EVENTS.length; i++) {
    var opt = document.createElement('option');
    opt.value = EVENTS[i].table;
    opt.textContent = EVENTS[i].name;
    sel.appendChild(opt);
  }
  sel.value = EVENTS[0].table;
  document.getElementById('currentEventName').textContent = EVENTS[0].name;
  loadGuests();
}

function onEventChange() {
  var sel = document.getElementById('eventSelect');
  currentTable = sel.value;
  for (var i = 0; i < EVENTS.length; i++) {
    if (EVENTS[i].table === currentTable) {
      document.getElementById('currentEventName').textContent = EVENTS[i].name;
      break;
    }
  }
  loadGuests();
}

function loadGuests() {
  showLoading();
  fetchAll(currentTable, function(records, err) {
    if (err) { showError('Error: ' + err); return; }
    allGuests = [];
    for (var i = 0; i < records.length; i++) {
      var f = records[i].fields;
      allGuests.push({
        id: records[i].id,
        name: f['Full Name'] || 'Unknown',
        photo: f['Photo'] ? f['Photo'][0].url : null,
        list: f['List'] || '',
        email: f['Email'] || '',
        phone: f['Phone'] || '',
        instagram: f['Instagram'] || '',
        checkedIn: f['Checked In'] || false,
        coatCheck: f['Coat Check #'] || '',
        phoneCheck: f['Phone Check #'] || '',
        doorNotes: f['Door Notes'] || '',
        nda: f['NDA'] || '',
        stiCleared: f['STI Cleared'] || false
      });
    }
    renderGuests('');
  });
}

function getTabGuests() {
  if (currentTab === 'all') return allGuests;
  if (currentTab === 'nda') return allGuests.filter(function(g) { return g.nda !== 'Signed'; });
  if (currentTab === 'Guest') return allGuests.filter(function(g) {
    var l = (g.list || '').toLowerCase();
    return !l.includes('work') && !l.includes('staff');
  });
  if (currentTab === 'Working') return allGuests.filter(function(g) {
    var l = (g.list || '').toLowerCase();
    return l.includes('work') || l.includes('staff');
  });
  return allGuests;
}

function filterGuests(query) { renderGuests(query); }

function wireCardOpen(card, guest) {
  // pointerup is more reliable on iOS than click (especially inside scrollable grids)
  card.addEventListener('pointerup', function(ev) {
    if (ev && typeof ev.button === 'number' && ev.button !== 0) return;
    openDetail(guest);
  });

  // Keyboard support (desktop)
  card.addEventListener('keydown', function(ev) {
    if (ev.key === 'Enter' || ev.key === ' ') {
      ev.preventDefault();
      openDetail(guest);
    }
  });
}

function renderGuests(query) {
  var guests = getTabGuests();
  if (query) {
    var q = query.toLowerCase();
    guests = guests.filter(function(g) { return g.name.toLowerCase().includes(q); });
  }
  document.getElementById('guestCount').textContent = guests.length + ' people';
  if (guests.length === 0) { showEmpty('No guests on this list.'); return; }

  var grid = document.createElement('div');
  grid.className = 'guest-grid';

  for (var i = 0; i < guests.length; i++) {
    (function(guest) {
      var card = document.createElement('div');
      card.className = 'guest-card' + (guest.checkedIn ? ' checked-in' : '');
      card.setAttribute('role', 'button');
      card.setAttribute('tabindex', '0');
      card.setAttribute('aria-label', 'Open ' + guest.name);

      var photoWrap = document.createElement('div');
      if (guest.photo) {
        photoWrap.className = 'guest-photo-wrap';
        var img = document.createElement('img');
        img.className = 'guest-photo';
        img.src = guest.photo;
        img.alt = guest.name;
        img.loading = 'lazy';
        photoWrap.appendChild(img);
      } else {
        photoWrap.className = 'guest-photo-placeholder';
        var span = document.createElement('span');
        span.textContent = guest.name.charAt(0);
        photoWrap.appendChild(span);
      }
      card.appendChild(photoWrap);

      var info = document.createElement('div');
      info.className = 'guest-card-info';
      var nameEl = document.createElement('div');
      nameEl.className = 'guest-card-name';
      nameEl.textContent = guest.name;
      info.appendChild(nameEl);
      if (guest.list) {
        var typeEl = document.createElement('div');
        typeEl.className = 'guest-card-type';
        typeEl.textContent = guest.list;
        info.appendChild(typeEl);
      }
      card.appendChild(info);

      // IMPORTANT: use our reliable handler
      wireCardOpen(card, guest);

      grid.appendChild(card);
    })(guests[i]);
  }

  var content = document.getElementById('mainContent');
  content.innerHTML = '';
  content.appendChild(grid);
}

function setTab(tab) {
  currentTab = tab;
  var tabs = document.querySelectorAll('.tab');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].classList.toggle('active', tabs[i].dataset.tab === tab);
  }
  renderGuests('');
}

function openDetail(guest) {
  currentGuest = guest;
  var dc = document.getElementById('detailContent');
  dc.innerHTML = '';

  // Photo
  var photoWrap = document.createElement('div');
  photoWrap.className = 'detail-photo-wrap';
  if (guest.photo) {
    var img = document.createElement('img');
    img.className = 'detail-photo';
    img.src = guest.photo;
    img.alt = guest.name;
    photoWrap.appendChild(img);
  } else {
    var ph = document.createElement('div');
    ph.className = 'detail-photo-placeholder';
    ph.textContent = guest.name.charAt(0);
    photoWrap.appendChild(ph);
  }
  dc.appendChild(photoWrap);

  // Name
  var nameEl = document.createElement('div');
  nameEl.className = 'detail-name';
  nameEl.textContent = guest.name;
  dc.appendChild(nameEl);

  // Badge
  if (guest.list) {
    var meta = document.createElement('div');
    meta.className = 'detail-meta';
    var badge = document.createElement('span');
    badge.className = 'detail-badge ' + ((guest.list || '').toLowerCase().includes('work') ? 'badge-working' : 'badge-guest');
    badge.textContent = guest.list;
    meta.appendChild(badge);
    dc.appendChild(meta);
  }

  // Contact info
  if (guest.phone || guest.email || guest.instagram) {
    var contact = document.createElement('div');
    contact.className = 'contact-info';
    if (guest.phone) {
      var p = document.createElement('div');
      p.className = 'contact-item';
      p.innerHTML = 'üìû <a href="tel:' + guest.phone + '" style="color:var(--brown);text-decoration:none;">' + guest.phone + '</a>';
      contact.appendChild(p);
    }
    if (guest.email) {
      var e = document.createElement('div');
      e.className = 'contact-item';
      e.innerHTML = '‚úâÔ∏è <a href="mailto:' + guest.email + '" style="color:var(--terracotta);text-decoration:none;">' + guest.email + '</a>';
      contact.appendChild(e);
    }
    if (guest.instagram) {
      var ig = document.createElement('div');
      ig.className = 'contact-item';
      var igHandle = guest.instagram.replace('https://www.instagram.com/','@').replace('https://instagram.com/','@').replace(/\/$/,'');
      ig.innerHTML = 'üì∏ <a href="' + guest.instagram + '" target="_blank" style="color:var(--brown);text-decoration:none;">' + igHandle + '</a>';
      contact.appendChild(ig);
    }
    dc.appendChild(contact);
  }

  // Check-in section
  var section = document.createElement('div');
  section.className = 'detail-section';
  section.innerHTML = '<div class="detail-section-title">Check-In</div>';

  // Checked In toggle
  section.appendChild(makeToggle('‚úì Checked In', 'chkCheckedIn', guest.checkedIn));

  // NDA toggle
  section.appendChild(makeToggle('‚úçÔ∏è NDA Signed', 'chkNDA', guest.nda === 'Signed'));

  // NDA unsigned row
  var ndaRow = document.createElement('div');
  ndaRow.id = 'ndaLinkRow';
  ndaRow.className = 'nda-unsigned-row';
  ndaRow.style.display = guest.nda === 'Signed' ? 'none' : 'block';
  ndaRow.innerHTML = '<div>üö© If NDA is unsigned, please <a href="https://forms.gle/asRXJtR6zHhDoGZJ8" target="_blank" style="color:var(--terracotta);font-weight:500;">click here</a> and have them sign:</div>';
  section.appendChild(ndaRow);

  // Wire NDA toggle to show/hide row
  var ndaChk = section.querySelector('#chkNDA');
  ndaChk.addEventListener('change', function() {
    ndaRow.style.display = this.checked ? 'none' : 'block';
  });

  // STI toggle
  section.appendChild(makeToggle('üß™ STI Cleared', 'chkSTI', guest.stiCleared));

  // Coat check
  section.appendChild(makeInput('üß• Coat Check #', 'inpCoat', guest.coatCheck, 'e.g. 69'));
  section.appendChild(makeInput('üì± Phone Check #', 'inpPhone', guest.phoneCheck, 'e.g. 69'));
  section.appendChild(makeTextarea('üìã Door Notes', 'inpNotes', guest.doorNotes));

  dc.appendChild(section);

  // Save button
  var btn = document.createElement('button');
  btn.className = 'save-btn';
  btn.textContent = 'Save Changes';
  btn.onclick = saveGuest;
  dc.appendChild(btn);

  document.getElementById('detailOverlay').classList.add('open');
  setTimeout(function() { document.getElementById('detailSheet').classList.add('open'); }, 10);
}

function makeToggle(label, id, checked) {
  var row = document.createElement('div');
  row.className = 'toggle-row';
  row.innerHTML = '<div class="toggle-label">' + label + '</div><label class="toggle"><input type="checkbox" id="' + id + '"' + (checked ? ' checked' : '') + '><span class="toggle-slider"></span></label>';
  return row;
}

function makeInput(label, id, value, placeholder) {
  var row = document.createElement('div');
  row.className = 'detail-input-row';
  row.innerHTML = '<div class="detail-input-label">' + label + '</div><input class="detail-input" id="' + id + '" type="text" value="' + (value||'') + '" placeholder="' + placeholder + '">';
  return row;
}

function makeTextarea(label, id, value) {
  var row = document.createElement('div');
  row.className = 'detail-input-row';
  row.innerHTML = '<div class="detail-input-label">' + label + '</div><textarea class="detail-input detail-textarea" id="' + id + '" placeholder="Any notes...">' + (value||'') + '</textarea>';
  return row;
}

function closeDetail() {
  document.getElementById('detailSheet').classList.remove('open');
  document.getElementById('detailOverlay').classList.remove('open');
}

function saveGuest() {
  var btn = document.querySelector('.save-btn');
  btn.textContent = 'Saving...';

  var checkedIn = document.getElementById('chkCheckedIn').checked;
  var ndaSigned = document.getElementById('chkNDA').checked;
  var stiCleared = document.getElementById('chkSTI').checked;
  var coatCheck = document.getElementById('inpCoat').value;
  var phoneCheck = document.getElementById('inpPhone').value;
  var doorNotes = document.getElementById('inpNotes').value;

  var xhr = new XMLHttpRequest();
  xhr.open('PATCH', 'https://api.airtable.com/v0/' + BASE_ID + '/' + encodeURIComponent(currentTable) + '/' + currentGuest.id);
  xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.onload = function() {
    currentGuest.checkedIn = checkedIn;
    currentGuest.nda = ndaSigned ? 'Signed' : 'No';
    currentGuest.stiCleared = stiCleared;
    currentGuest.coatCheck = coatCheck;
    currentGuest.phoneCheck = phoneCheck;
    currentGuest.doorNotes = doorNotes;
    for (var i = 0; i < allGuests.length; i++) {
      if (allGuests[i].id === currentGuest.id) { allGuests[i] = currentGuest; break; }
    }
    btn.textContent = 'Saved ‚úì';
    setTimeout(function() { closeDetail(); renderGuests(''); }, 600);
  };
  xhr.onerror = function() { btn.textContent = 'Error ‚Äî Try Again'; };
  xhr.send(JSON.stringify({ fields: { 'Checked In': checkedIn, 'NDA': ndaSigned ? 'Signed' : 'No', 'STI Cleared': stiCleared, 'Coat Check #': coatCheck, 'Phone Check #': phoneCheck, 'Door Notes': doorNotes } }));
}

function showLoading() {
  document.getElementById('mainContent').innerHTML =
    '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">Opening the doors...</div></div>';
}

function showEmpty(msg) {
  document.getElementById('mainContent').innerHTML = '<div class="empty-state">' + msg + '</div>';
  document.getElementById('guestCount').textContent = '';
}

function showError(msg) {
  document.getElementById('mainContent').innerHTML = '<div class="error-state">' + msg + '</div>';
}

init();
</script>
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div>
      <div class="logo">LouLou's</div>
      <div class="event-name" id="currentEventName"></div>
    </div>
    <div class="guest-count" id="guestCount"></div>
  </div>
  <div class="tabs">
    <button class="tab active" data-tab="all" onclick="setTab('all')">üë• Door List</button>
    <button class="tab" data-tab="Guest" onclick="setTab('Guest')">üî• Guests</button>
    <button class="tab" data-tab="Working" onclick="setTab('Working')">üé≠ Working</button>
    <button class="tab" data-tab="nda" onclick="setTab('nda')">‚úçÔ∏è NDAs</button>
  </div>
</div>

<div class="event-selector">
  <select class="event-select" id="eventSelect" onchange="onEventChange()">
    <option value="">‚Äî Select Event ‚Äî</option>
  </select>
</div>

<div class="search-bar">
  <input class="search-input" type="search" placeholder="Search guests..." oninput="filterGuests(this.value)" />
</div>

<div id="mainContent">
  <div class="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">Opening the doors...</div>
  </div>
</div>

<div class="detail-overlay" id="detailOverlay" onclick="closeDetail()"></div>
<div class="detail-sheet" id="detailSheet">
  <div class="detail-handle"></div>
  <div id="detailContent"></div>
</div>

<script>
var TOKEN = 'patQHgI1DOfeXw98H.da543b89b12e2aaa5a30980aafb3e5df35c6f87e5c23f7fa9c22e443ff5816f6';
var BASE_ID = 'appY6p2HwRtDmOvAf';

var EVENTS = [
  { name: "L'Atelier | March 28th", table: "3/28 Door List" },
  { name: "Do Not Disturb II | Feb 28th", table: "2/28 Door List" },
  { name: "Do Not Disturb I | Dec 13th", table: "12/13 Door List" }
];

var allGuests = [];
var currentTab = 'all';
var currentTable = EVENTS[0].table;
var currentGuest = null;

function apiHeaders() {
  return { 'Authorization': 'Bearer ' + TOKEN, 'Content-Type': 'application/json' };
}

function fetchAll(table, callback) {
  var records = [];
  function fetchPage(offset) {
    var url = 'https://api.airtable.com/v0/' + BASE_ID + '/' + encodeURIComponent(table) + '?pageSize=100';
    if (offset) url += '&offset=' + offset;
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN);
    xhr.onload = function() {
      var data = JSON.parse(xhr.responseText);
      if (data.error) { callback(null, data.error.message); return; }
      records = records.concat(data.records);
      if (data.offset) { fetchPage(data.offset); } else { callback(records, null); }
    };
    xhr.onerror = function() { callback(null, 'Network error'); };
    xhr.send();
  }
  fetchPage(null);
}

function init() {
  var sel = document.getElementById('eventSelect');
  for (var i = 0; i < EVENTS.length; i++) {
    var opt = document.createElement('option');
    opt.value = EVENTS[i].table;
    opt.textContent = EVENTS[i].name;
    sel.appendChild(opt);
  }
  sel.value = EVENTS[0].table;
  document.getElementById('currentEventName').textContent = EVENTS[0].name;
  loadGuests();
}

function onEventChange() {
  var sel = document.getElementById('eventSelect');
  currentTable = sel.value;
  for (var i = 0; i < EVENTS.length; i++) {
    if (EVENTS[i].table === currentTable) {
      document.getElementById('currentEventName').textContent = EVENTS[i].name;
      break;
    }
  }
  loadGuests();
}

function loadGuests() {
  showLoading();
  fetchAll(currentTable, function(records, err) {
    if (err) { showError('Error: ' + err); return; }
    allGuests = [];
    for (var i = 0; i < records.length; i++) {
      var f = records[i].fields;
      allGuests.push({
        id: records[i].id,
        name: f['Full Name'] || 'Unknown',
        photo: f['Photo'] ? f['Photo'][0].url : null,
        list: f['List'] || '',
        email: f['Email'] || '',
        phone: f['Phone'] || '',
        instagram: f['Instagram'] || '',
        checkedIn: f['Checked In'] || false,
        coatCheck: f['Coat Check #'] || '',
        phoneCheck: f['Phone Check #'] || '',
        doorNotes: f['Door Notes'] || '',
        nda: f['NDA'] || '',
        stiCleared: f['STI Cleared'] || false
      });
    }
    renderGuests('');
  });
}

function getTabGuests() {
  if (currentTab === 'all') return allGuests;
  if (currentTab === 'nda') return allGuests.filter(function(g) { return g.nda !== 'Signed'; });
  if (currentTab === 'Guest') return allGuests.filter(function(g) {
    var l = (g.list || '').toLowerCase();
    return !l.includes('work') && !l.includes('staff');
  });
  if (currentTab === 'Working') return allGuests.filter(function(g) {
    var l = (g.list || '').toLowerCase();
    return l.includes('work') || l.includes('staff');
  });
  return allGuests;
}

function filterGuests(query) { renderGuests(query); }

function renderGuests(query) {
  var guests = getTabGuests();
  if (query) {
    var q = query.toLowerCase();
    guests = guests.filter(function(g) { return g.name.toLowerCase().includes(q); });
  }
  document.getElementById('guestCount').textContent = guests.length + ' people';
  if (guests.length === 0) { showEmpty('No guests on this list.'); return; }

  var grid = document.createElement('div');
  grid.className = 'guest-grid';

  for (var i = 0; i < guests.length; i++) {
    (function(guest) {
      var card = document.createElement('div');
      card.className = 'guest-card' + (guest.checkedIn ? ' checked-in' : '');

      var photoWrap = document.createElement('div');
      if (guest.photo) {
        photoWrap.className = 'guest-photo-wrap';
        var img = document.createElement('img');
        img.className = 'guest-photo';
        img.src = guest.photo;
        img.alt = guest.name;
        img.loading = 'lazy';
        photoWrap.appendChild(img);
      } else {
        photoWrap.className = 'guest-photo-placeholder';
        var span = document.createElement('span');
        span.textContent = guest.name.charAt(0);
        photoWrap.appendChild(span);
      }
      card.appendChild(photoWrap);

      var info = document.createElement('div');
      info.className = 'guest-card-info';
      var nameEl = document.createElement('div');
      nameEl.className = 'guest-card-name';
      nameEl.textContent = guest.name;
      info.appendChild(nameEl);
      if (guest.list) {
        var typeEl = document.createElement('div');
        typeEl.className = 'guest-card-type';
        typeEl.textContent = guest.list;
        info.appendChild(typeEl);
      }
      card.appendChild(info);

      card.addEventListener('click', function() { openDetail(guest); });
      grid.appendChild(card);
    })(guests[i]);
  }

  var content = document.getElementById('mainContent');
  content.innerHTML = '';
  content.appendChild(grid);
}

function setTab(tab) {
  currentTab = tab;
  var tabs = document.querySelectorAll('.tab');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].classList.toggle('active', tabs[i].dataset.tab === tab);
  }
  renderGuests('');
}

function openDetail(guest) {
  currentGuest = guest;
  var dc = document.getElementById('detailContent');
  dc.innerHTML = '';

  // Photo
  var photoWrap = document.createElement('div');
  photoWrap.className = 'detail-photo-wrap';
  if (guest.photo) {
    var img = document.createElement('img');
    img.className = 'detail-photo';
    img.src = guest.photo;
    img.alt = guest.name;
    photoWrap.appendChild(img);
  } else {
    var ph = document.createElement('div');
    ph.className = 'detail-photo-placeholder';
    ph.textContent = guest.name.charAt(0);
    photoWrap.appendChild(ph);
  }
  dc.appendChild(photoWrap);

  // Name
  var nameEl = document.createElement('div');
  nameEl.className = 'detail-name';
  nameEl.textContent = guest.name;
  dc.appendChild(nameEl);

  // Badge
  if (guest.list) {
    var meta = document.createElement('div');
    meta.className = 'detail-meta';
    var badge = document.createElement('span');
    badge.className = 'detail-badge ' + ((guest.list || '').toLowerCase().includes('work') ? 'badge-working' : 'badge-guest');
    badge.textContent = guest.list;
    meta.appendChild(badge);
    dc.appendChild(meta);
  }

  // Contact info
  if (guest.phone || guest.email || guest.instagram) {
    var contact = document.createElement('div');
    contact.className = 'contact-info';
    if (guest.phone) {
      var p = document.createElement('div');
      p.className = 'contact-item';
      p.innerHTML = 'üìû <a href="tel:' + guest.phone + '" style="color:var(--brown);text-decoration:none;">' + guest.phone + '</a>';
      contact.appendChild(p);
    }
    if (guest.email) {
      var e = document.createElement('div');
      e.className = 'contact-item';
      e.innerHTML = '‚úâÔ∏è <a href="mailto:' + guest.email + '" style="color:var(--terracotta);text-decoration:none;">' + guest.email + '</a>';
      contact.appendChild(e);
    }
    if (guest.instagram) {
      var ig = document.createElement('div');
      ig.className = 'contact-item';
      var igHandle = guest.instagram.replace('https://www.instagram.com/','@').replace('https://instagram.com/','@').replace(/\/$/,'');
      ig.innerHTML = 'üì∏ <a href="' + guest.instagram + '" target="_blank" style="color:var(--brown);text-decoration:none;">' + igHandle + '</a>';
      contact.appendChild(ig);
    }
    dc.appendChild(contact);
  }

  // Check-in section
  var section = document.createElement('div');
  section.className = 'detail-section';
  section.innerHTML = '<div class="detail-section-title">Check-In</div>';

  // Checked In toggle
  section.appendChild(makeToggle('‚úì Checked In', 'chkCheckedIn', guest.checkedIn));

  // NDA toggle
  section.appendChild(makeToggle('‚úçÔ∏è NDA Signed', 'chkNDA', guest.nda === 'Signed'));

  // NDA unsigned row
  var ndaRow = document.createElement('div');
  ndaRow.id = 'ndaLinkRow';
  ndaRow.className = 'nda-unsigned-row';
  ndaRow.style.display = guest.nda === 'Signed' ? 'none' : 'block';
  ndaRow.innerHTML = '<div>üö© If NDA is unsigned, please <a href="https://forms.gle/asRXJtR6zHhDoGZJ8" target="_blank" style="color:var(--terracotta);font-weight:500;">click here</a> and have them sign:</div>';
  section.appendChild(ndaRow);

  // Wire NDA toggle to show/hide row
  var ndaChk = section.querySelector('#chkNDA');
  ndaChk.addEventListener('change', function() {
    ndaRow.style.display = this.checked ? 'none' : 'block';
  });

  // STI toggle
  section.appendChild(makeToggle('üß™ STI Cleared', 'chkSTI', guest.stiCleared));

  // Coat check
  section.appendChild(makeInput('üß• Coat Check #', 'inpCoat', guest.coatCheck, 'e.g. 69'));
  section.appendChild(makeInput('üì± Phone Check #', 'inpPhone', guest.phoneCheck, 'e.g. 69'));
  section.appendChild(makeTextarea('üìã Door Notes', 'inpNotes', guest.doorNotes));

  dc.appendChild(section);

  // Save button
  var btn = document.createElement('button');
  btn.className = 'save-btn';
  btn.textContent = 'Save Changes';
  btn.onclick = saveGuest;
  dc.appendChild(btn);

  document.getElementById('detailOverlay').classList.add('open');
  setTimeout(function() { document.getElementById('detailSheet').classList.add('open'); }, 10);
}

function makeToggle(label, id, checked) {
  var row = document.createElement('div');
  row.className = 'toggle-row';
  row.innerHTML = '<div class="toggle-label">' + label + '</div><label class="toggle"><input type="checkbox" id="' + id + '"' + (checked ? ' checked' : '') + '><span class="toggle-slider"></span></label>';
  return row;
}

function makeInput(label, id, value, placeholder) {
  var row = document.createElement('div');
  row.className = 'detail-input-row';
  row.innerHTML = '<div class="detail-input-label">' + label + '</div><input class="detail-input" id="' + id + '" type="text" value="' + (value||'') + '" placeholder="' + placeholder + '">';
  return row;
}

function makeTextarea(label, id, value) {
  var row = document.createElement('div');
  row.className = 'detail-input-row';
  row.innerHTML = '<div class="detail-input-label">' + label + '</div><textarea class="detail-input detail-textarea" id="' + id + '" placeholder="Any notes...">' + (value||'') + '</textarea>';
  return row;
}

function closeDetail() {
  document.getElementById('detailSheet').classList.remove('open');
  document.getElementById('detailOverlay').classList.remove('open');
}

function saveGuest() {
  var btn = document.querySelector('.save-btn');
  btn.textContent = 'Saving...';

  var checkedIn = document.getElementById('chkCheckedIn').checked;
  var ndaSigned = document.getElementById('chkNDA').checked;
  var stiCleared = document.getElementById('chkSTI').checked;
  var coatCheck = document.getElementById('inpCoat').value;
  var phoneCheck = document.getElementById('inpPhone').value;
  var doorNotes = document.getElementById('inpNotes').value;

  var xhr = new XMLHttpRequest();
  xhr.open('PATCH', 'https://api.airtable.com/v0/' + BASE_ID + '/' + encodeURIComponent(currentTable) + '/' + currentGuest.id);
  xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.onload = function() {
    currentGuest.checkedIn = checkedIn;
    currentGuest.nda = ndaSigned ? 'Signed' : 'No';
    currentGuest.stiCleared = stiCleared;
    currentGuest.coatCheck = coatCheck;
    currentGuest.phoneCheck = phoneCheck;
    currentGuest.doorNotes = doorNotes;
    for (var i = 0; i < allGuests.length; i++) {
      if (allGuests[i].id === currentGuest.id) { allGuests[i] = currentGuest; break; }
    }
    btn.textContent = 'Saved ‚úì';
    setTimeout(function() { closeDetail(); renderGuests(''); }, 600);
  };
  xhr.onerror = function() { btn.textContent = 'Error ‚Äî Try Again'; };
  xhr.send(JSON.stringify({ fields: { 'Checked In': checkedIn, 'NDA': ndaSigned ? 'Signed' : 'No', 'STI Cleared': stiCleared, 'Coat Check #': coatCheck, 'Phone Check #': phoneCheck, 'Door Notes': doorNotes } }));
}

function showLoading() {
  document.getElementById('mainContent').innerHTML = '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">Opening the doors...</div></div>';
}
function showEmpty(msg) {
  document.getElementById('mainContent').innerHTML = '<div class="empty-state">' + msg + '</div>';
  document.getElementById('guestCount').textContent = '';
}
function showError(msg) {
  document.getElementById('mainContent').innerHTML = '<div class="error-state">' + msg + '</div>';
}

init();
</script>
</body>
</html>
