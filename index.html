<script>
  // 1) Your Cloudflare Worker base URL (yours is this)
  const API_BASE = "https://ancient-wave-ed39.concierge-07f.workers.dev";

  // 2) App state (starts empty, loads from Airtable via the Worker)
  const state = {
    tab: "door",
    q: "",
    guests: [],
    current: null,
    events: [],
    eventId: null,
    auth: null, // "Basic xxxxx" stored after login
  };

  // 3) Grab DOM nodes (keep your existing ones)
  const grid = document.getElementById("grid");
  const count = document.getElementById("count");
  const overlay = document.getElementById("overlay");
  const sheet = document.getElementById("sheet");
  const detail = document.getElementById("detail");

  // If your event dropdown has a specific id, put it here.
  // If you don't know it, leave as null and we’ll still load guests for the first event.
  const eventSelect =
    document.getElementById("eventSelect") ||
    document.getElementById("event") ||
    document.querySelector("select");

  const searchInput =
    document.getElementById("search") ||
    document.querySelector('input[type="search"]') ||
    document.querySelector('input[placeholder*="Search"]');

  // 4) Auth helpers
  function setAuth(username, passcode) {
    const token = btoa(`${username}:${passcode}`);
    state.auth = `Basic ${token}`;
    localStorage.setItem("loulous_auth", state.auth);
  }

  function loadAuth() {
    const saved = localStorage.getItem("loulous_auth");
    if (saved) state.auth = saved;
  }

  async function api(path, opts = {}) {
    const headers = new Headers(opts.headers || {});
    headers.set("Accept", "application/json");

    // Send auth if we have it (prevents browser popups)
    if (state.auth) headers.set("Authorization", state.auth);

    // If we're sending JSON
    if (opts.body && !headers.has("Content-Type")) {
      headers.set("Content-Type", "application/json");
    }

    const res = await fetch(`${API_BASE}${path}`, { ...opts, headers });

    if (res.status === 401) {
      // Force the login modal flow (instead of the browser basic-auth popup)
      throw new Error("unauthorized");
    }

    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(`API error ${res.status}: ${text}`);
    }

    // Some endpoints may return empty
    const ct = res.headers.get("content-type") || "";
    if (!ct.includes("application/json")) return null;
    return res.json();
  }

  // 5) Minimal login prompt (nice modal later, but this works now)
  async function ensureAuth() {
    loadAuth();
    if (state.auth) return;

    const username = prompt("LouLou Staff Username:");
    const passcode = prompt("Passcode:");
    if (!username || !passcode) throw new Error("Missing username/passcode");
    setAuth(username, passcode);

    // quick verification
    await api("/api/ping");
  }

  // 6) Load events + guests
  async function loadEvents() {
    // Expect: [{ id, name, date, guestCount }]
    const events = await api("/api/events");
    state.events = Array.isArray(events) ? events : [];
    if (!state.eventId && state.events.length) state.eventId = state.events[0].id;

    // Fill dropdown if it exists
    if (eventSelect && state.events.length) {
      eventSelect.innerHTML = state.events
        .map(
          (e) =>
            `<option value="${e.id}" ${
              e.id === state.eventId ? "selected" : ""
            }>${escapeHtml(e.name || "Event")}${e.date ? " | " + escapeHtml(e.date) : ""}</option>`
        )
        .join("");

      eventSelect.onchange = async () => {
        state.eventId = eventSelect.value;
        await loadGuests();
      };
    }
  }

  async function loadGuests() {
    if (!state.eventId) return;

    // Expect: [{ id, name, type, photo, checked, vip, nda, sti, email, phone, instagram, ... }]
    const guests = await api(`/api/guests?eventId=${encodeURIComponent(state.eventId)}`);
    state.guests = Array.isArray(guests) ? guests : [];

    // Re-render using your existing functions if they exist
    if (typeof render === "function") render();
    else renderFallback();
  }

  // 7) Fallback renderer (so it’s clickable even if your render() is missing/broken)
  function renderFallback() {
    const q = (state.q || "").toLowerCase().trim();
    const list = state.guests.filter((g) => {
      const name = (g.name || "").toLowerCase();
      const type = (g.type || "").toLowerCase();

      if (state.tab === "working") return type.includes("work") || type.includes("staff");
      if (state.tab === "ndas") return !g.nda;
      if (state.tab === "guests") return !(type.includes("work") || type.includes("staff"));

      // door tab = everyone
      return true;
    }).filter((g) => !q || (g.name || "").toLowerCase().includes(q));

    if (count) count.textContent = `${list.length} people`;

    if (!grid) return;
    grid.innerHTML = list
      .map((g) => {
        const photo = g.photo || g.photoUrl || g.image || "";
        const initials = (g.name || "?")
          .split(" ")
          .slice(0, 2)
          .map((s) => s[0] || "")
          .join("")
          .toUpperCase();

        return `
          <button class="guestCard" data-id="${escapeAttr(g.id)}" type="button">
            <div class="avatar">
              ${
                photo
                  ? `<img src="${escapeAttr(photo)}" alt="${escapeAttr(g.name || "Guest")}" />`
                  : `<div class="initials">${escapeHtml(initials)}</div>`
              }
            </div>
            <div class="meta">
              <div class="name">${escapeHtml(g.name || "")}</div>
              <div class="type">${escapeHtml(g.type || "")}</div>
            </div>
          </button>
        `;
      })
      .join("");

    // Make cards clickable
    grid.querySelectorAll(".guestCard").forEach((btn) => {
      btn.addEventListener("click", () => openGuest(btn.dataset.id));
    });
  }

  function openGuest(id) {
    const g = state.guests.find((x) => String(x.id) === String(id));
    state.current = g || null;

    if (typeof openSheet === "function") {
      openSheet(g);
      return;
    }

    // fallback detail
    if (!detail) return;
    detail.innerHTML = g
      ? `
        <div style="padding:16px">
          <div style="font-size:18px;font-weight:600">${escapeHtml(g.name || "")}</div>
          <div style="opacity:.7;margin-top:4px">${escapeHtml(g.type || "")}</div>
          <div style="margin-top:12px;display:grid;gap:8px">
            <label><input type="checkbox" ${g.checked ? "checked" : ""} data-field="checked"> Checked in</label>
            <label><input type="checkbox" ${g.vip ? "checked" : ""} data-field="vip"> VIP</label>
            <label><input type="checkbox" ${g.nda ? "checked" : ""} data-field="nda"> NDA</label>
            <label><input type="checkbox" ${g.sti ? "checked" : ""} data-field="sti"> STI Verified</label>
          </div>
        </div>
      `
      : "";

    // show overlay/sheet if present
    if (overlay) overlay.classList.add("show");
    if (sheet) sheet.classList.add("show");

    // wire toggles -> PATCH to API
    detail.querySelectorAll('input[type="checkbox"][data-field]').forEach((cb) => {
      cb.addEventListener("change", async () => {
        const field = cb.getAttribute("data-field");
        const value = cb.checked;

        try {
          await api(`/api/guests/${encodeURIComponent(g.id)}`, {
            method: "PATCH",
            body: JSON.stringify({ [field]: value }),
          });
          g[field] = value;
        } catch (e) {
          alert("Save failed. Try again.");
          cb.checked = !value;
        }
      });
    });
  }

  // 8) Search wiring
  if (searchInput) {
    searchInput.addEventListener("input", () => {
      state.q = searchInput.value || "";
      if (typeof render === "function") render();
      else renderFallback();
    });
  }

  // 9) Tiny safe escaping helpers
  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  function escapeAttr(s) {
    return escapeHtml(s).replaceAll("`", "&#096;");
  }

  // 10) Boot
  (async function boot() {
    try {
      await ensureAuth();
      await loadEvents();
      await loadGuests();
    } catch (e) {
      if (String(e.message).includes("unauthorized")) {
        localStorage.removeItem("loulous_auth");
        alert("Login needed. Refresh and enter your staff username + passcode.");
      } else {
        console.error(e);
        alert("Could not load. Open Console for details.");
      }
    }
  })();
</script>
